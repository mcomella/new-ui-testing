#filter substitution
/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

package @ANDROID_PACKAGE_NAME@.tests;

import com.jayway.android.robotium.solo.Solo;

import android.app.Activity;
import android.content.pm.ActivityInfo;
import android.os.Build;
import android.util.DisplayMetrics;
import java.lang.Class;
import java.lang.ClassLoader;
import java.lang.reflect.Method;

final class DeviceHelper {
    private static final String APP_SHELL_CLASS = "org.mozilla.gecko.GeckoAppShell";

    public enum Type {
        PHONE,
        TABLET
    }

    public enum AndroidPlatformVersion {
        v2x,
        v3x,
        v4x
    }

    private static UITestContext sTestContext;

    private static Type sDeviceType;
    private static AndroidPlatformVersion sAndroidVersion;

    private static int sScreenHeight;
    private static int sScreenWidth;

    public DeviceHelper() { /* To disallow instantiation. */ }

    public static void init(final UITestContext context) {
        sTestContext = context;

        setAndroidVersion();
        setScreenDimensions();
        setDeviceType();
    }

    private static void setAndroidVersion() {
        int sdk = Build.VERSION.SDK_INT;
        if (sdk < Build.VERSION_CODES.HONEYCOMB) {
            sAndroidVersion = AndroidPlatformVersion.v2x;
        } else {
            if (sdk > Build.VERSION_CODES.HONEYCOMB_MR2) {
                sAndroidVersion = AndroidPlatformVersion.v4x;
            } else {
                sAndroidVersion = AndroidPlatformVersion.v3x;
            }
        }
    }

    private static void setScreenDimensions() {
        final Activity activity = sTestContext.getActivity();
        final DisplayMetrics dm = new DisplayMetrics();
        activity.getWindowManager().getDefaultDisplay().getMetrics(dm);
        sScreenHeight = dm.heightPixels;
        sScreenWidth = dm.widthPixels;
    }

    private static void setDeviceType() {
        final Activity activity = sTestContext.getActivity();
        boolean isTablet = false;
        try {
            // TODO: Bug 709230: Remove reflection?
            final ClassLoader cl = activity.getClassLoader();
            final Class appShellClass = cl.loadClass(APP_SHELL_CLASS);
            final Method isTabletMethod = appShellClass.getMethod("isTablet");
            isTablet = ((Boolean) isTabletMethod.invoke(null)).booleanValue();
        } catch (Exception e) {
            sTestContext.dumpLog("Exception in detectDevice", e);
        }

        sDeviceType = (isTablet ? Type.TABLET : Type.PHONE);
    }

    public static int getScreenHeight() {
        return sScreenHeight;
    }

    public static int getScreenWidth() {
        return sScreenWidth;
    }

    public static AndroidPlatformVersion getAndroidVersion() {
        return sAndroidVersion;
    }

    public static boolean isPhone() {
        return (sDeviceType == Type.PHONE);
    }

    public static boolean isTablet() {
        return (sDeviceType == Type.TABLET);
    }

    public static void rotate() {
        final Solo solo = sTestContext.getSolo();
        final Activity activity = sTestContext.getActivity();

        if (activity.getRequestedOrientation () == ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE) {
            solo.setActivityOrientation(Solo.PORTRAIT);
        } else {
            solo.setActivityOrientation(Solo.LANDSCAPE);
        }
    }
}
